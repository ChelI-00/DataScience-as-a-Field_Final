---
title: "COVID19 Data Analysis"
author: "CIfill"
date: "2025-01-24"
output: html_document
---

Please ensure you have the following packages before knitting:

* Tidyverse
* dplyr
* httr
* jsonlite
* plotly
* scales

```{r setup, echo = TRUE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE) #suppresses warnings in the knit
library(tidyverse)
library(dplyr)
library(httr)
library(jsonlite)
library(plotly)
library(scales)
library(randomForest)

set.seed(1)
```

 
## Data Source

The following report will look at the number of cases and deaths during the COVID-19 pandemic, focusing on the United States and general global numbers. The main dataset will comprise of data from the Johns Hopkins University repository, accessed through Github.

Through this analysis, we hope to identify the rate of infections and deaths, as well as the areas most affected by the COVID-19 pandemic.

``` {r JHU_covid_import, echo = TRUE}

url_in <- "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/refs/heads/master/csse_covid_19_data/csse_covid_19_time_series/"

file_names <- c("time_series_covid19_confirmed_global.csv", "time_series_covid19_deaths_global.csv", "time_series_covid19_confirmed_US.csv", "time_series_covid19_deaths_US.csv")

urls <- str_c(url_in, file_names)

global_cases <- read_csv(urls[1])
global_deaths <- read_csv(urls[2])
us_cases <- read_csv(urls[3])
us_deaths <- read_csv(urls[4])
```

The next bit of data will come from the Centers for Disease Control and Prevention (CDC), specifically the COVID deaths grouped by state by sex for various age groups.

``` {r CDC_covid_import, echo = TRUE}

api_url <- "https://data.cdc.gov/resource/9bhg-hcku.json?$limit=200000"

stateDeaths_w_age_sex <- fromJSON(content(GET(api_url), "text"), flatten = TRUE)
```

Lastly, the political party by state for the US from their 2020 election year. The better dataset for the predictive model, seen later on, would be the population spread by age. However, the data from the United States Census database was too difficult to process for this project. For now, the political affiliation will act as an extra feature.

``` {r PolParty_import, echo = TRUE}

state_PolParty <- read.csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vS3Z8Rq9xqOLISwoKdK0n6CFLBuPSCoXbbLeY8vhi-rzFS3ZFNEtR0BCdEbHcS-2Tlh5aPcnZbwBLao/pub?output=csv")

```

## Tidying the Data

### Cleaning

For US Cases and US Deaths, remove unnecessary columns 1-11 and 1-12 respectively. Rename Admin2 to County, iso2 to Country_Short (country abbreviation), fips to FIPS (county code), and cases to deaths in the US Deaths dataset. Lastly, convert the "dates" column from character to date type.

``` {r JHU_US_cleaning, echo = TRUE}
us_cases <- us_cases %>%
  pivot_longer(
    cols = !c(1:11),
    names_to = "dates",
    values_to = "cases",
    values_transform = as.numeric
  ) %>%
  select(-UID, -(iso3 : code3), -(Country_Region : Combined_Key)) %>%
  rename(County = Admin2, Country_Short = iso2, fips = FIPS) %>%
  mutate(dates = mdy(dates))
  
us_deaths <- us_deaths %>%
  pivot_longer(
    cols = !c(1:12),
    names_to = "dates",
    values_to = "cases",
    values_transform = as.numeric
  ) %>%
  select(-UID, -(iso3 : code3), -(Country_Region : Combined_Key)) %>%
  rename(County = Admin2, Country_Short = iso2, fips = FIPS, deaths = cases) %>%
  mutate(dates = mdy(dates)) %>%
  filter(!Population %in% c(0), !is.na(Population))

summary(us_cases)
summary(us_deaths)
```


Global Cases and Global Deaths needed their dates columns unpivoted and renamed to "dates" and "cases". Rename two columns to get rid of the "/", convert the dates column from character to date type, and remove the "Lat" and "Long" columns.


``` {r JHU_Global_cleaning}

global_cases <- global_cases %>%
  pivot_longer(
    cols = !c(1:4),
    names_to = "dates",
    values_to = "cases",
    values_transform = as.numeric
  ) %>%
  rename(Prov_State = 'Province/State', Country_Region = 'Country/Region') %>%
  mutate(dates = mdy(dates)) %>%
  select(-Lat, -Long)
  
global_deaths <- global_deaths %>%
  pivot_longer(
    cols = !c(1:4),
    names_to = "dates",
    values_to = "cases",
    values_transform = as.numeric
  ) %>%
  rename(Prov_State = 'Province/State', Country_Region = 'Country/Region', deaths = cases) %>%
  mutate(dates = mdy(dates)) %>%
  select(-Lat, -Long)

summary(global_cases)
summary(global_deaths)
```

The CDC data had summary rows, so removed them by filtering out "All Ages", "All Sexes", and "United States". Remove unnecessary columns, and convert "month", "year" and "covid_19_deaths" to numeric type.

``` {r CDC_cleaning, echo = TRUE}

stateDeaths_w_age_sex <- stateDeaths_w_age_sex %>%
    select(-(data_as_of:group), -(total_deaths:footnote)) %>%
    filter(!sex %in% c('All Sexes'), !age_group %in% c('All Ages'), !state %in% c('United States'), !covid_19_deaths %in% c(0)) %>%
    drop_na(year, month, covid_19_deaths) %>%
    mutate(month = as.numeric(month), year = as.numeric(year), covid_19_deaths = as.numeric(covid_19_deaths))

summary(stateDeaths_w_age_sex)
```

Political party data set was filtered for only the by-state information.

``` {r PolPar_cleaning, echo = TRUE}

state_PolParty <- state_PolParty %>%
    select(state, called) %>%
    filter(
      !state %in% c("U.S. Total", "15 Key Battlegrounds", "Non-Battlegrounds"), 
      !grepl("1st District", state), 
      !grepl("2nd District", state), 
      !grepl("3rd District", state)
      )

```


### Join and Summarize

From my understanding, the deaths column isn't a deaths by day, but more of a total deaths as of that day. Strangely, when calculating the delta, there are areas of negative deaths. While this is possible for the cases column, where some people have COVID (positive delta) and some recover (negative delta) or died (negative delta), there shouldn't be instances of negative death (someone comes back to life). I will leave the negatives. If it was incorrectly entered as a new death and then retracted, the negative will cancel out the addition.

However, because of the lag function, the delta column is incorrect in the following case: row x has County-A Dec 31st, 2022 with 500 deaths, but row x=1 is now County-B Jan 01, 2020 with 0 deaths, the delta logs this as -500 deaths. Got around this issue by using ifelse to check for the changes (i.e. if there is a change, the deaths delta is set to zero).

``` {r join_us_cases_death, echo = TRUE}

usCovid_delta <- us_cases %>%
    full_join(us_deaths) %>%
    filter(cases != 0) %>%
    mutate( PrevCases = lag(cases, n = 1), 
            PrevDeaths = lag(deaths, n = 1),
            NewCases = ifelse( 
                        County == lag(County, n = 1),
                        cases - PrevCases,
                        0),
            NewDeaths = ifelse( 
                        County == lag(County, n = 1),
                        deaths - PrevDeaths,
                        0)
            ) %>%
    select(-PrevCases, -PrevDeaths)
```

``` {r join_global_cases_death, echo = TRUE}

global <- global_cases %>%
  full_join(global_deaths) %>%
  group_by(Prov_State, Country_Region, year(dates), month(dates)) %>%
  summarise(cases = max(cases), deaths = max(deaths))
```

``` {r CDC_deaths_w_polpar, echo = TRUE}

#use this for the modeling

stateDeaths_w_age_sex <- stateDeaths_w_age_sex %>%
    full_join(state_PolParty)
```

## Visuals and Analysis

The following is a heatmap showing the mean number of deaths by age by state for the US. Texas and California stand out, specifically in the higher age groups.

``` {r age_heatmap, echo = TRUE, fig.width = 10, fig.height = 10}
ageGroup_heatmap <- stateDeaths_w_age_sex %>%
  group_by(state, age_group) %>%
  summarise(mean_deaths = mean(covid_19_deaths))

plot_ly(
  ageGroup_heatmap, 
  x = ~age_group, 
  y = ~state, 
  z = ~mean_deaths, 
  type = "heatmap"
  ) %>% 
  layout(title = 'Mean Deaths by State')
```

Next graph showcases the number of cases and deaths in the United States as a whole, from Jan 2020 to March 2023. 

``` {r us_covid_logScale, echo = TRUE, fig.width = 10}

#From what I've seen in the data, case and death counts start in march for most states

usCovid_delta_total <- usCovid_delta %>%
  filter(Country_Short == "US") %>%
  group_by(Year = year(dates), Month = month(dates)) %>%
  summarise(cases_delta = sum(NewCases, na.rm=T), deaths_delta = sum(NewDeaths, na.rm=T))

ggplot(usCovid_delta_total) +
  geom_line(
    aes(
      x = as.factor(Month), 
      y = cases_delta, 
      group = as.factor(Year), 
      colour = "Cases"), 
    linewidth = 1) +
  geom_line(
    aes(
      x = as.factor(Month), 
      y = deaths_delta, 
      group = as.factor(Year), 
      colour = "Deaths"), 
    linewidth = 1) +
  facet_grid(.~Year, scales = "free") +
  scale_y_continuous(trans = "log10", labels = comma) +
  labs(x = "Month",y = "Volume") + 
  ggtitle("COVID Cases and Deaths in the USA") +
  scale_color_manual(name = "COVID", values = c("Cases" = "blue", "Deaths" = "red"))
```

Create the same graph for COVID numbers globally. 

``` {r global_covid_logScale, echo = TRUE, fig.width = 10}

global_delta_total <- global_cases %>%
    full_join(global_deaths) %>%
    filter(cases != 0) %>%
    mutate( PrevCases = lag(cases, n = 1), 
            PrevDeaths = lag(deaths, n = 1),
            NewCases = ifelse( 
                        (Prov_State == lag(Prov_State, n = 1) | is.na(Prov_State)) & Country_Region == lag(Country_Region, n = 1),
                        cases - PrevCases,
                        0),
            NewDeaths = ifelse( 
                        (Prov_State == lag(Prov_State, n = 1) | is.na(Prov_State))  & Country_Region == lag(Country_Region, n = 1),
                        deaths - PrevDeaths,
                        0)
            ) %>%
    select(-PrevCases, -PrevDeaths) %>%
    filter(!((Country_Region == "France" & is.na(Prov_State)) | (Country_Region == "United Kingdom" & is.na(Prov_State))) & dates != 2020-01-22) %>%
    group_by(year = year(dates), month = month(dates)) %>%
    summarise(cases_delta = sum(NewCases, na.rm=T), deaths_delta = sum(NewDeaths, na.rm=T))

#Strange happenings: the lag function in the following code works for everything row except where United Arab Emirates becomes United Kingdom, and Finland becomes France. I cannot find the issue, and trying the Lag function from Hmisc has the same issue. Since they are the only two instances, I have purposely removed them.

ggplot(global_delta_total) +
  geom_line(aes(x = as.factor(month), y = cases_delta, group = as.factor(year), colour = "Cases"), linewidth = 1) + 
  geom_line(aes(x = as.factor(month), y = deaths_delta, group = as.factor(year), colour = "Deaths"), linewidth = 1) +
  facet_grid(.~year, scales = "free") +
  scale_y_continuous(trans = "log10", labels = comma) +
  labs(x = "Month",y = "Volume") + 
  ggtitle("COVID Cases and Deaths Globally") +
  scale_color_manual(name = "COVID", values = c("Cases" = "blue", "Deaths" = "red"))
```

Globally, 2022 had the highest number of cases, but the largest gap between cases and deaths compared to the other years.At this time, many countries were well into the vaccine roll out, as observed by the World Health Organization. This could potentially explain how the case numbers jump at the beginning of 2022 (vaccination allowed for more socializing and fewer lock down restrictions, as seen here <https://ourworldindata.org/covid-vaccinations>) 


From the heatmap, California, Texas and Florida had the highest mean deaths in the ageing population. They are the three most populous states of the US, as seen in the table below. 
    
``` {r pops_byState}

us_pops_byState <- us_deaths %>%
    filter(Country_Short == "US") %>%
    group_by(County, Province_State) %>%
    summarise(Population = mean(Population)) %>%
    group_by(Province_State) %>%
    summarise( total_pop = sum(Population, na.rm=T)) %>%
    arrange(desc(total_pop)) %>%
    head(10)

knitr::kable(us_pops_byState, "simple", format.args = list(big.mark = ",",
  scientific = FALSE), col.names = c("State", "Total Population"))
```

As seen in the table below, the counties with the highest single day increase in COVID cases and deaths were warmer-climate counties, where the population is more likely to be outdoors.

``` {r NewCD_byState}
us_singleDayInc <- usCovid_delta %>%
    filter(Country_Short == "US", !is.na(Population)) %>%
    group_by(County, Province_State) %>%
    summarise(
      Population = mean(Population),  
      high_NewCases = max(NewCases, na.rm = T), 
      high_NewDeaths = max(NewDeaths, na.rm = T)) %>%
    arrange(desc(high_NewCases), desc(high_NewDeaths)) %>%
    head(10)

knitr::kable(us_singleDayInc, "simple", format.args = list(big.mark = ",",
  scientific = FALSE), col.names = c("County", "State", "Population", "Max New Cases", "Max New Deaths"))
```
    
``` {r CDC_groupings, echo = TRUE}

us_deathsBy_sex <- stateDeaths_w_age_sex %>%
    group_by(sex) %>%
    summarise(total_deaths = sum(covid_19_deaths)) %>%
    mutate(deci = total_deaths / sum(total_deaths)) %>% 
    mutate(perc = scales::percent(deci))

us_deathsBy_age_group <- stateDeaths_w_age_sex %>%
  group_by(age_group) %>%
  summarise(total_deaths = sum(covid_19_deaths)) %>%
  mutate(deci = total_deaths / sum(total_deaths)) %>% 
  mutate(perc = scales::percent(deci))
```

Diving deeper into the sex of those who died from COVID in the US, `r us_deathsBy_sex$perc[us_deathsBy_sex$sex == "Female"]` were female (`r prettyNum(us_deathsBy_sex$total_deaths[us_deathsBy_sex$sex == "Female"], big.mark = ",")` total) and `r us_deathsBy_sex$perc[us_deathsBy_sex$sex == "Male"]` were male (`r prettyNum(us_deathsBy_sex$total_deaths[us_deathsBy_sex$sex == "Male"], big.mark = ",")` total). Compare this to the total US population where 50.25% is male, 49.75% is female (as of 2023, World Bank Group <https://data.worldbank.org/indicator/SP.POP.TOTL.FE.ZS?locations=US&view=map&year=2023>)

Deaths by age group highlights the fact that people past retirement age are high-risk for infections and viruses. Approximately `r with(us_deathsBy_age_group, scales::percent(sum(deci[age_group == "65-74 years" | age_group == "75-84 years" | age_group == "85 years and over"])))` of the deaths were people 65 years and older. 


## Models

``` {r rfm, echo = TRUE}

stateDeaths_w_age_sex <- na.omit(stateDeaths_w_age_sex)

model <- randomForest(
  formula = covid_19_deaths ~ ., 
  data = stateDeaths_w_age_sex,
  mtry = 6
  )

print(model)

stateDeaths_w_age_sex <- na.omit(stateDeaths_w_age_sex) %>%
  mutate(pred = round(predict(model),2))
```

The mean squared residuals of our score means the model was off by this many deaths on average. The lower this number and the higher the % variance, the better.

``` {r model_v_US, echo = TRUE, fig.width = 10}
#Compare model to whole US
us_v_Pred <- stateDeaths_w_age_sex %>% 
  group_by(year, month) %>%
  summarise(deaths = sum(covid_19_deaths, na.rm = T), pred = sum(pred, na.rm = T))

ggplot(us_v_Pred) +
  geom_line(aes(x = as.factor(month), y = deaths, group = as.factor(year), colour = "Actuals"), linewidth = 1) + 
  geom_line(aes(x = as.factor(month), y = pred, group = as.factor(year), colour = "Model"), linewidth = 1) +
  facet_grid(.~year, scales = "free") +
  scale_y_continuous(trans = "log10", labels = comma) +
  labs(x = "Month",y = "Volume") + 
  ggtitle("COVID Deaths in the US: Prediction vs Actuals") +
  scale_color_manual(name = "COVID", values = c("Actuals" = "steelblue", "Model" = "orange3"))

```

Visually, the model looks very close to the actuals. The next graph focuses on the state of California and will show it is not as clean when the model for the US as a whole is used state by state.

``` {r model_v_Calif, echo = TRUE, fig.width = 10}
#compare model to actual for California
Calif_v_Pred <- stateDeaths_w_age_sex %>% 
    filter(state == "California") %>%
    group_by(state, year, month) %>%
    summarise(deaths = sum(covid_19_deaths, na.rm = T), pred = sum(pred, na.rm = T))

ggplot(Calif_v_Pred) +
  geom_line(aes(x = as.factor(month), y = deaths, group = as.factor(year), colour = "Actuals"), linewidth = 1) + 
  geom_line(aes(x = as.factor(month), y = pred, group = as.factor(year), colour = "Model"), linewidth = 1) +
  facet_grid(.~year, scales = "free") +
  scale_y_continuous(trans = "log10", labels = comma) +
  labs(x = "Month",y = "Volume") + 
  ggtitle("COVID Deaths in California: Prediction vs Actuals") +
  scale_color_manual(name = "COVID", values = c("Actuals" = "steelblue", "Model" = "orange3"))

```




## Biases

**Sampling Bias**: not having the same amount of info for other countries (and as easily available) as for the USA. Some countries may have been unable to or unwilling to properly report COVID cases and deaths.

As well, choosing to import the political party by state instead of the religious demographic spread or another feature can be seen as a bias.

**Preprocessing bias**: There is only so much data I can compile. At some point, I wanted to import the US census data, but the output had variable codes instead of the text names and would have taken much more time to clean. To avoid going down a rabbit hole and wasting time, I had to close off that route.





## Appendix

``` {r session_info, echo = TRUE}
sessionInfo()
```

### Citations

National Center for Health Statistics. Provisional COVID-19 Deaths by County, and Race and Hispanic Origin. Date accessed [`r today()`].  <https://data.cdc.gov/NCHS/Provisional-COVID-19-Death-Counts-in-the-United-St/kn79-hsxy/data_preview>

Johns Hopkins Center for Systems Science and Engineering. Novel Coronavirus (COVID-19) Cases. Date accessed [`r today()`] <https://github.com/CSSEGISandData/COVID-19>

The Cook Political Report (with Amy Walter). Popular Vote Backend. Date accessed [`r today()`]. <https://www.cookpolitical.com/vote-tracker/2020/electoral-college>
 
 
### Sites Used for Coding Help

Access data with API Endpoint and JSON url

* <https://www.geeksforgeeks.org/access-collect-data-with-apis-in-r/>

More than 1000 rows SODA API

* <https://stackoverflow.com/questions/71804530/using-limit-and-offset-to-get-more-than-1-000-rows-on-a-soda-api>

Unpivot columns

* <https://datacornering.com/unpivot-data-in-r-with-the-pivot_longer-from-tidyr/>

  
  *Some unpivot cols are numeric, some are char          <https://stackoverflow.com/questions/71482059/pivot-longer-error-cant-combine-01-01-2020-character-and-03-01-2020-dou>
  
Rename column using dplyr

* <https://www.statology.org/how-to-rename-data-frame-columns-in-r/>

Create new output of delta cases by day

* <https://stackoverflow.com/questions/59645369/calculate-daily-difference-per-id-in-r-dataframe>

Citing data sources

* <https://dataverse.org/best-practices/data-citation>

Import from Github using httr (I got a SSL Connect error):

* <https://stackoverflow.com/questions/41814897/loading-csv-file-from-private-github-repo-using-httr>

Mutate based on conditional

* <https://www.r4epi.com/conditional-operations>

Plotly Heatmap

* <https://plotly.com/r/heatmaps/>

Multi row x axis

* <https://stackoverflow.com/questions/20571306/multi-row-x-axis-labels-in-ggplot-line-chart>

Sum in Summarise showing NA values

* <https://stackoverflow.com/questions/59283479/r-summarise-by-group-sum-giving-na>

Add a legend to ggplot with separate lines

* <https://stackoverflow.com/questions/40833809/add-legend-to-geom-line-graph-in-r>



